const expensesKey = 'expenses_v1';
const expensesList = document.getElementById('expensesList');
const totalAmount = document.getElementById('totalAmount');
const expenseForm = document.getElementById('expenseForm');
const exportCsvBtn = document.getElementById('exportCsv');
const toggleDark = document.getElementById('toggleDark');
const logoutBtn = document.getElementById('logout');
const clearAllBtn = document.getElementById('clearAll');

// Get expenses from localStorage
const getExpenses = () => JSON.parse(localStorage.getItem(expensesKey) || '[]');

// Save expenses to localStorage
const saveExpenses = arr => localStorage.setItem(expensesKey, JSON.stringify(arr));

// Format date
const formatDate = d => (d ? new Date(d).toLocaleDateString() : '');

// Render all expenses
const render = () => {
  const items = getExpenses();
  expensesList.innerHTML = '';

  let total = 0;

  items.forEach((it, idx) => {
    total += Number(it.amount);

    const li = document.createElement('li');
    li.innerHTML = `
      <div class="meta">
        <span class="amount">Rs ${Number(it.amount).toFixed(2)}</span>
        <span>${it.description}</span>
        <span>${formatDate(it.date)}</span>
      </div>

      <div>
        <button class="edit alt" data-idx="${idx}">Edit</button>
        <button class="del alt" data-idx="${idx}">Delete</button>
      </div>
    `;

    expensesList.appendChild(li);
  });

  totalAmount.textContent = total.toFixed(2);
  attachHandlers();
};

// Attach edit/delete button handlers
const attachHandlers = () => {
  document.querySelectorAll('.del').forEach(btn => {
    btn.onclick = e => {
      const index = Number(e.target.dataset.idx);
      const arr = getExpenses().filter((_, i) => i !== index);
      saveExpenses(arr);
      render();
    };
  });

  document.querySelectorAll('.edit').forEach(btn => {
    btn.onclick = e => {
      const index = Number(e.target.dataset.idx);
      const arr = getExpenses();
      const { amount, description, date } = arr[index];

      document.getElementById('amount').value = amount;
      document.getElementById('description').value = description;
      document.getElementById('date').value = date;

      // Remove old entry while editing
      saveExpenses(arr.filter((_, i) => i !== index));
      render();
    };
  });
};

// Add new expense
expenseForm.addEventListener('submit', e => {
  e.preventDefault();

  const amount = Number(document.getElementById('amount').value);
  const description = document.getElementById('description').value.trim();
  const date = document.getElementById('date').value;

  if (!amount || !description) {
    alert('Enter amount & description');
    return;
  }

  const arr = getExpenses();
  arr.unshift({ amount, description, date });

  saveExpenses(arr);
  expenseForm.reset();
  render();
});

// Export as CSV
exportCsvBtn.addEventListener('click', () => {
  const items = getExpenses();

  if (!items.length) {
    alert('No expenses to export');
    return;
  }

  const rows = [['Amount', 'Description', 'Date'], 
    ...items.map(it => [it.amount, it.description, it.date || ''])
  ];

  const csv = rows.map(r => r.join(',')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);

  const a = document.createElement('a');
  a.href = url;
  a.download = 'expenses.csv';
  a.click();
  URL.revokeObjectURL(url);
});

// Dark mode toggle
toggleDark.addEventListener('click', () => {
  document.body.classList.toggle('dark');
  localStorage.setItem('dark', document.body.classList.contains('dark') ? '1' : '0');
});

// Logout
logoutBtn.addEventListener('click', () => {
  localStorage.removeItem('loggedIn');
  window.location.href = 'login.html';
});

// Clear all expenses
clearAllBtn.addEventListener('click', () => {
  if (confirm('Clear all expenses?')) {
    saveExpenses([]);
    render();
  }
});

// Load dark mode if previously set
if (localStorage.getItem('dark') === '1') {
  document.body.classList.add('dark');
}

// Initial render
render();
